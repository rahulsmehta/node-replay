var d=require("./lib/proxy.js"),h=require("url"),j=require("fs"),k=require("https"),l=require("crypto"),m=process.d.slice(2)[0],o;m&&"-"===m.charAt(0)&&(cmd=m.substring(1),"c"===cmd?o=!0:"r"===cmd&&(o=!1));"undefined"===typeof o&&(o=!0);console.log(o?"Running in capture mode...":"Running in replay mode...");var p=["/GOST/"];function q(a){var b;for(b=0;b<p.length;++b)if(this.contains(a,p[b]))return true;return false}function r(a,b,e){var c=l.f("md5");c.update(a+b+e,"utf8");return c.h("hex")}
function s(a){var b,e,c,i,f,g,n;a.a("request",function(a){i=b=a.url;c=a.method});a.a("request_data",function(a){e=a.toString("utf8",0,a.length)});a.a("response",function(a){f=a.l;n=a.headers});a.a("response_data",function(a){g=a.toString("utf8",0,a.length)});a.a("response_end",function(){if(q(b))console.log("Excluding "+b);else{var a=r(e,c,i),t=j.k("data/"+a,"w+");try{g=JSON.parse(g)}catch(x){g={}}console.log(b+" -> "+a);a=JSON.stringify({code:f,headers:n,data:g});j.o(t,a)}})}
function u(){this.m=function(a){var b=h.i(a.path);if(q(b))console.log("Excluding "+b);else{a.hostname="localhost";a.port=8888}}}new d({"proxy-port":8080,verbose:!1},o?s:u);
if(!o){var v=j.b("lib/certs/agent2-key.pem","utf8"),w=j.b("lib/certs/agent2-cert.pem","utf8");replayServer=k.g({key:v,e:w},function(a,b){var e;a.a("data",function(a){e=a.toString("utf8",0,a.length)});a.a("end",function(){var c=a.url,i=r(e,a.method,c);console.log(c+" -> "+i);var f,c=false;try{f=JSON.parse(j.b("data/"+i,"utf8"))}catch(g){c=true}if(c)b.write("{}");else{b.n(f.code,f.headers);_resData=JSON.stringify(f.data);b.write(_resData)}b.end()})});replayServer.j(8888);console.log("Replay server started at port "+
replayServer.c().port)};